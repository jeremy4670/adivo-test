<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADIVO Field Tool</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f0f2f5; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h2 { margin-top: 0; color: #202124; text-align: center; }
        
        /* Buttons */
        button { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 8px; font-weight: 600; font-size: 15px; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-gps { background: #1a73e8; color: white; }
        .btn-link { background: #fbbc04; color: #333; margin-bottom: 25px; border: 1px solid #e0a800; }
        .btn-submit { background: #34a853; color: white; font-size: 16px; margin-top: 20px; }
        
        /* Status Text */
        #loc-display { margin: 10px 0; font-size: 14px; color: #5f6368; text-align: center; min-height: 20px; }
        
        /* Form Elements */
        label { display: block; font-weight: 500; font-size: 13px; color: #444; margin-bottom: 4px; margin-top: 15px;}
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        input:focus, select:focus, textarea:focus { border-color: #1a73e8; outline: none; }
        
        .row { display: flex; gap: 15px; }
        .col { flex: 1; }
        
        /* Unit tags inside inputs */
        .input-wrap { position: relative; }
        .unit { position: absolute; right: 12px; top: 12px; color: #888; font-size: 12px; pointer-events: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>ADIVO Field Data üìù</h2>
    
    <button onclick="getGPSAndName()" class="btn-gps">üìç 1. Find Location</button>
    <div id="loc-display">Tap button to start...</div>

    <p style="font-size: 13px; margin-bottom: 5px; color: #444; font-weight: 500;">2. Get trusted BOM data:</p>
    <button onclick="openWillyWeather()" class="btn-link" id="btn-willy" disabled>üåä Find Report (via Google)</button>

    <form name="submit-to-google-sheet">
        <input type="hidden" name="gps" id="gps">
        <input type="hidden" name="timestamp" id="timestamp">
        <input type="hidden" name="location_name_db" id="location_name_db">
        <input type="hidden" name="state" id="state">
        <input type="hidden" name="postcode" id="postcode">

        <div class="row">
            <div class="col">
                <label>Swell Height</label>
                <div class="input-wrap">
                    <input type="number" step="0.1" name="wave_height" placeholder="e.g. 1.5">
                    <span class="unit">m</span>
                </div>
            </div>
            <div class="col">
                <label>Swell Period</label>
                <div class="input-wrap">
                    <input type="number" step="0.1" name="swell_period" placeholder="e.g. 8">
                    <span class="unit">s</span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>Tide Height</label>
                <div class="input-wrap">
                    <input type="number" step="0.1" name="tide_level" placeholder="e.g. 1.2">
                    <span class="unit">m</span>
                </div>
            </div>
            <div class="col">
                <label>Wind Speed</label>
                <div class="input-wrap">
                    <input type="number" step="0.1" name="wind_speed" placeholder="e.g. 15">
                    <span class="unit">km/h</span>
                </div>
            </div>
        </div>

        <label>Observer Name</label>
        <input type="text" name="observer" required>

        <label>Test Case</label>
        <select name="test_case">
            <option>Case A - Pool</option>
            <option>Case B - Swim</option>
            <option>Case C - Craft</option>
            <option>Case D - Durability</option>
        </select>

        <label>Notes</label>
        <textarea name="notes" rows="3" placeholder="Failures, observations..."></textarea>

        <button type="submit" id="submit-btn" class="btn-submit">‚úÖ Submit Data</button>
    </form>
</div>

<script>
    // ** YOUR GOOGLE APPS SCRIPT URL **
    const scriptURL = 'https://script.google.com/macros/s/AKfycbw-hoDx3Xiy3-mW3-qy0ne4F4sv8MFxwZ4WxGnT_u9t8wr4s0-JXToGkILyQNfdtP8C7Q/exec';
    
    // Global variables to store location data
    let detectedName = "";
    let detectedState = "";
    let detectedPostcode = "";
    
    const STATE_MAP = {
        "Queensland": "QLD", "New South Wales": "NSW", "Victoria": "VIC",
        "Tasmania": "TAS", "South Australia": "SA", "Western Australia": "WA",
        "Northern Territory": "NT", "Australian Capital Territory": "ACT"
    };

    function getGPSAndName() {
        const display = document.getElementById('loc-display');
        const willyBtn = document.getElementById('btn-willy');
        
        if (!navigator.geolocation) return alert("GPS not supported");
        
        display.innerText = "Acquiring GPS...";
        
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                
                document.getElementById('gps').value = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
                display.innerText = `GPS Found. Getting Address...`;
                
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`)
                    .then(res => res.json())
                    .then(data => {
                        const addr = data.address || {};
                        
                        const suburb = addr.suburb || addr.town || addr.city || addr.village || "";
                        const rawState = addr.state || "";
                        const postcode = addr.postcode || "";
                        const shortState = STATE_MAP[rawState] || rawState;
                        
                        // Store globally for the button
                        detectedName = suburb;
                        detectedState = shortState;
                        detectedPostcode = postcode;
                        
                        // Update Hidden Fields
                        document.getElementById('location_name_db').value = suburb;
                        document.getElementById('state').value = shortState;
                        document.getElementById('postcode').value = postcode;
                        
                        if (suburb) {
                            display.innerText = `üìç ${suburb}, ${shortState} ${postcode}`;
                            willyBtn.innerText = `üåä Find Report for ${suburb}`;
                            willyBtn.disabled = false;
                        } else {
                            display.innerText = `GPS: ${lat.toFixed(3)}, ${lon.toFixed(3)} (Unknown Name)`;
                            willyBtn.innerText = "üåä Find Report (via Google)";
                            willyBtn.disabled = false;
                        }
                    })
                    .catch(() => {
                        display.innerText = "Address fetch failed. GPS saved.";
                        willyBtn.innerText = "üåä Find Report (via Google)";
                        willyBtn.disabled = false;
                    });
            }, 
            (err) => {
                alert("GPS Error: " + err.message + ". Check permissions.");
                display.innerText = "GPS Failed.";
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    function openWillyWeather() {
        // We use Google Search to find the specific WillyWeather page
        // This avoids 404 errors because Google always knows the correct link.
        let query = "site:willyweather.com.au";
        
        if (detectedName) {
            query += ` ${detectedName}`;
            if (detectedState) query += ` ${detectedState}`;
            if (detectedPostcode) query += ` ${detectedPostcode}`;
        } else {
            // Fallback if no GPS name found
            query += " Australia weather";
        }
        
        const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
        window.open(url, '_blank');
    }

    const form = document.forms['submit-to-google-sheet'];
    form.addEventListener('submit', e => {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        if(btn.disabled) return;
        
        btn.disabled = true;
        btn.innerText = "Sending...";
        document.getElementById('timestamp').value = new Date().toLocaleString();
        
        fetch(scriptURL, { method: 'POST', body: new FormData(form)})
            .then(() => { 
                alert("‚úÖ Data Saved Successfully!"); 
                document.querySelector('textarea').value = "";
                document.querySelector('input[name="observer"]').value = "";
                btn.disabled = false; 
                btn.innerText = "‚úÖ Submit Data"; 
            })
            .catch(() => {
                alert("Error saving. Check internet.");
                btn.disabled = false;
                btn.innerText = "‚úÖ Submit Data"; 
            });
    });
</script>
</body>
</html>